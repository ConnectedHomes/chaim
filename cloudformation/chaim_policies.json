{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "MostRecentlyUpsertedBy": {
      "Type": "String",
      "Description": "The version of the stack that is deployed"
    }
  },
  "Outputs": {
    "MostRecentlyUpsertedBy": {
      "Value": {
        "Ref": "MostRecentlyUpsertedBy"
      },
      "Description": "The user who most recently upserted this stack"
    }
  },
  "Resources": {
    "ChaimCognitoManageUser": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "ChaimCognitoManageUser",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "ChaimCognitoManageUser0",
              "Effect": "Allow",
              "Action": [
                "cognito-idp:AdminDeleteUser",
                "cognito-idp:AdminEnableUser",
                "cognito-idp:AdminCreateUser",
                "cognito-idp:AdminDisableUser",
                "cognito-idp:AdminGetUser",
                "cognito-idp:ListUser"
              ],
              "Resource": {
                "Fn::Join": [
                  "",
                    [
                      "arn:aws:cognito-idp:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "userpool/",
                      {
                        "Ref": "CognitoUserPoolId"
                      }
                    ]
                ]
              }
            }
          ]
        }
      }
    },
    "ChaimManageAccessKey": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "ChaimManageAccessKey",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "ChaimManageAccessKey0",
              "Effect": "Allow",
              "Action": [
                "iam:DeleteAccessKey",
                "iam:GetAccessKeyLastUsed",
                "iam:UpdateAccessKey",
                "iam:GetUser",
                "iam:CreateAccessKey",
                "iam:ListAccessKeys"
              ],
              "Resource": {
                "Fn::Join": [
                  "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "user/",
                      {
                        "Ref": "ChaimUser"
                      }
                    ]
                ]
              }
            }
          ]
        }
      }
    },
    "ChaimParameterstoreWrite": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "ChaimParameterstoreWrite",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "ChaimParameterstoreWrite0",
              "Effect": "Allow",
              "Action": [
                "ssm:PutParameter",
                "kms:Decrypt",
                "kms:Encrypt",
                "ssm:GetParametersByPath",
                "ssm:GetParameters",
                "ssm:GetParameter"
              ],
              "Resource": [
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:kms:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "key/",
                      {
                        "Ref": "KeyId"
                      }
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:ssm:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "parameter/sre/chaim/*"
                    ]
                  ]
                }
              ]
            },
            {
              "Sid": "ChaimParameterstoreWrite1",
              "Effect": "Allow",
              "Action": "ssm:DescribeParameters",
              "Resource": "*"
            }
          ]
        }
      }
    },
    "ChaimPublishToSNS": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "ChaimPublishToSNS",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "ChaimPublishToSNS0",
              "Effect": "Allow",
              "Action": "sns:Publish",
              "Resource": [
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "chaim-slack-helper"
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "ChaimSlackBeta"
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "ChaimSlackProd"
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "sre-honeypass"
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "sre-honeyhub"
                    ]
                  ]
                },
                { "Fn::Join": [
                  "",
                    [
                      "arn:aws:sns:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "sre-hc-pw-reset"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "CognitoGetUserStatus": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "CognitoGetUserStatus",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "CognitoGetUserStatus0",
              "Effect": "Allow",
              "Action": [
                "cognito-idp:AdminGetUser",
                "cognito-idp:List*"
              ],
              "Resource": {
                "Fn::Join": [
                  "",
                    [
                      "arn:aws:cognito-idp:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "userpool/",
                      {
                        "Ref": "CognitoUserPoolId"
                      }
                    ]
                ]
              }
            }
          ]
        }
      }
    },
    "CognitoManageUserPool": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "CognitoManageUserPool",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "CognitoManageUserPool0",
              "Effect": "Allow",
              "Action": [
                "cognito-idp:ListUsersInGroup",
                "cognito-idp:ListGroups",
                "cognito-idp:AdminListDevices",
                "cognito-idp:AdminCreateUser",
                "cognito-idp:ListDevices",
                "cognito-idp:AdminDisableUser",
                "cognito-idp:AdminListGroupsForUser",
                "cognito-idp:AdminGetUser",
                "cognito-idp:ListUserPoolClients",
                "cognito-idp:ListUserImportJobs"
              ],
              "Resource": {
                "Fn::Join": [
                  "",
                    [
                      "arn:aws:cognito-idp:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "userpool/",
                      {
                        "Ref": "CognitoUserPoolId"
                      }
                    ]
                ]
              }
            }
          ]
        }
      }
    },
    "STSAssumeRole": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "STSAssumeRole",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "STSAssumeRole0",
              "Effect": "Allow",
              "Action": [
                "sts:GetSessionToken",
                "sts:AssumeRole"
              ],
              "Resource": "*"
            }
          ]
        },
      }
    }
  }
