AWSTemplateFormatVersion: 2010-09-09
Parameters:
  ChaimUser:
    Type: String
    Description: The IAM Chaim User
  ChaimUserRole:
    Type: String
    Description: Tag for Chaim User
  ChaimLambdaRDSRoleName:
    Type: String
    Description: Tag for Chaim Lambda RDS Role
  ChaimLambdaKeymanRoleName:
    Type: String
    Description: Tag for Chaim Lambda Keyman Role
  Owner:
    Type: String
    Description: The owner of the product
  Product:
    Type: String
    Description: The product this stack provides
  Environment:
    Type: String
    Description: The environment the product will be built in
Resources:
  ChaimCognito:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/chaimcloudformationtemplates/dd95b35d4375cec7d07ce51842e5dbbc.template
      Parameters:
        Owner:
          Ref: Owner
        Product:
          Ref: Product
        Environment:
          Ref: Environment
  ChaimIAM:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/chaimcloudformationtemplates/dedb76edde970203063bcdeb5a5f8759.template
      Parameters:
        ChaimCognitoUserPool:
          Fn::GetAtt:
          - ChaimCognito
          - Outputs.ChaimCognitoUserPoolId
        ChaimLambdaRDSRoleName:
          Ref: ChaimLambdaRDSRoleName
        ChaimLambdaKeymanRoleName:
          Ref: ChaimLambdaKeymanRoleName
        ChaimUser:
          Ref: ChaimUser
        ChaimUserRole:
          Ref: ChaimUserRole
        Environment:
          Ref: Environment
        Owner:
          Ref: Owner
        Product:
          Ref: Product
    DependsOn: ChaimCognito
  ChaimKMS:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/chaimcloudformationtemplates/c6205d7b9b4767b0e216c65f9cd1fc81.template
      Parameters:
        ChaimLambdaRDSRoleName:
          Ref: ChaimLambdaRDSRoleName
        Environment:
          Ref: Environment
        Owner:
          Ref: Owner
        Product:
          Ref: Product
    DependsOn: ChaimIAM
  ChaimIAM2:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/chaimcloudformationtemplates/66dd84bb6a2b6154618a29a0f4f8198e.template
      Parameters:
        ChaimKMSKey:
          Fn::GetAtt:
          - ChaimKMS
          - Outputs.ChaimKMSKeyId
        ChaimLambdaRDSRole:
          Fn::GetAtt:
          - ChaimIAM
          - Outputs.ChaimLambdaRDSRoleId
        ChaimLambdaKeymanRole:
          Fn::GetAtt:
          - ChaimIAM
          - Outputs.ChaimLambdaKeymanRoleId
        Environment:
          Ref: Environment
        Owner:
          Ref: Owner
        Product:
          Ref: Product
    DependsOn: ChaimKMS
